<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unit | JLMS</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAaNDRralbB3_Ybbivz9E1QrOmk3VMlCN4",
      authDomain: "jlms-teaching-platform.firebaseapp.com",
      projectId: "jlms-teaching-platform",
      storageBucket: "jlms-teaching-platform.appspot.com",
      messagingSenderId: "193970336189",
      appId: "1:193970336189:web:17572a6b9176a984a5a2d4",
      measurementId: "G-DDG3NTYVQS"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>

<body class="bg-gray-50 text-gray-800 font-['Noto Sans TC'] p-4">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold" id="unit-title">Loading...</h1>
    <div>
      <span id="status" class="mr-4">Checking login...</span>
      <button id="loginBtn" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 transition">Login</button>
      <button id="logoutBtn" class="bg-gray-600 text-white px-4 py-1 rounded hover:bg-gray-700 transition hidden">Logout</button>
    </div>
  </header>

  <div class="md:flex gap-6">
    <!-- Sidebar -->
    <aside class="md:w-1/4 mb-6 md:mb-0">
      <div id="unit-list" class="space-y-2"></div>
    </aside>

    <!-- Main Content -->
    <main class="md:w-3/4" id="unit-content">
      <!-- Navigation -->
      <div class="bg-[#50afaf] text-white rounded-xl p-4 mb-6 flex flex-wrap justify-between items-center">
        <a href="resources.html" class="hover:underline">‚Üê Back to course overview</a>
        <div class="flex gap-6">
          <a href="#" id="prevBtn" class="hover:underline">Previous Lesson</a>
          <a href="#" id="nextBtn" class="hover:underline">Next Lesson ‚Üí</a>
        </div>
      </div>

      <!-- YouTube -->
      <div class="flex justify-center mb-6">
        <div id="youtube-preview" class="w-full max-w-[640px] aspect-video mx-auto"></div>
      </div>

      <!-- PDFs -->
      <div class="space-y-6">
        <div id="pdf-tr" class="hidden max-w-[768px] mx-auto">
          <h2 class="font-semibold text-lg mb-2">üìÑ PDF (Traditionnel)</h2>
          <iframe class="w-full h-[640px] border rounded" id="iframe-tr" src=""></iframe>
          <a id="download-tr" href="#" class="text-blue-600 hover:underline block mt-1" download>Download PDF</a>
        </div>
        <div id="pdf-sim" class="hidden max-w-[768px] mx-auto">
          <h2 class="font-semibold text-lg mb-2">üìÑ PDF (Simplifi√©)</h2>
          <iframe class="w-full h-[640px] border rounded" id="iframe-sim" src=""></iframe>
          <a id="download-sim" href="#" class="text-blue-600 hover:underline block mt-1" download>Download PDF</a>
        </div>
      </div>
    </main>
  </div>

  <script>
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbztppbQ0vQuen9deXXGp99yeWrMsPHYCQn_MKVYl-1WL9AS5Zg7nlVyQrCGa8yxWwnBvg/exec";
    const params = new URLSearchParams(window.location.search);
    const lessonId = params.get("id");
    const cat = params.get("cat");
    const level = params.get("level");

    function extractYouTubeId(url) {
      try {
        const yt = new URL(url);
        if (yt.hostname.includes("youtu.be")) return yt.pathname.slice(1);
        if (yt.searchParams.get("v")) return yt.searchParams.get("v");
      } catch (e) {
        return null;
      }
    }

    firebase.auth().onAuthStateChanged(user => {
      const statusEl = document.getElementById("status");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      if (user) {
        statusEl.textContent = `üëã Welcome, ${user.email}`;
        logoutBtn.classList.remove("hidden");
        loginBtn.classList.add("hidden");
      } else {
        statusEl.textContent = "üîê Not logged in";
        logoutBtn.classList.add("hidden");
        loginBtn.classList.remove("hidden");
      }

      logoutBtn.onclick = () => firebase.auth().signOut().then(() => location.reload());
      loginBtn.onclick = () => location.href = "login.html";
    });

    fetch(SHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        const filtered = data.filter(row => {
          return (!cat || row["\u5206\u985eCat\u00e9gorie"] === cat) &&
                 (!level || row["\u7a0b\u5ea6Niveau"] === level);
        });

        const currentLesson = filtered.find(row => row["\u55ae\u5143ID"] === lessonId);
        if (!currentLesson) return;

        // Sidebar rendering
        const listEl = document.getElementById("unit-list");
        filtered.forEach(row => {
          const isActive = row["\u55ae\u5143ID"] === lessonId;
          const div = document.createElement("div");
          div.className = `p-3 rounded cursor-pointer ${isActive ? 'bg-blue-100 font-semibold' : 'hover:bg-gray-100'}`;
          div.textContent = row["\u540d\u7a31Titre"];
          div.onclick = () => {
            location.href = `unit.html?id=${encodeURIComponent(row["\u55ae\u5143ID"])}&cat=${encodeURIComponent(cat)}&level=${encodeURIComponent(level)}`;
          };
          listEl.appendChild(div);
        });

        // Title
        document.getElementById("unit-title").textContent = currentLesson["\u540d\u7a31Titre"] || "Lesson";

        // YouTube
        if (currentLesson.YouTube) {
          const videoId = extractYouTubeId(currentLesson.YouTube);
          if (videoId) {
            document.getElementById("youtube-preview").innerHTML = `
              <iframe class="w-full h-full rounded" 
                      src="https://www.youtube.com/embed/${videoId}" 
                      frameborder="0" allowfullscreen></iframe>`;
          }
        }

        // PDF
        if (currentLesson["PDF\u6a94\u6848ID (traditionnel)"]) {
          const id = currentLesson["PDF\u6a94\u6848ID (traditionnel)"];
          document.getElementById("pdf-tr").classList.remove("hidden");
          document.getElementById("iframe-tr").src = `https://drive.google.com/file/d/${id}/preview`;
          document.getElementById("download-tr").href = `https://drive.google.com/uc?export=download&id=${id}`;
        }

        if (currentLesson["PDF\u6a94\u6848ID (simplifi\u00e9)"]) {
          const id = currentLesson["PDF\u6a94\u6848ID (simplifi\u00e9)"];
          document.getElementById("pdf-sim").classList.remove("hidden");
          document.getElementById("iframe-sim").src = `https://drive.google.com/file/d/${id}/preview`;
          document.getElementById("download-sim").href = `https://drive.google.com/uc?export=download&id=${id}`;
        }
      });
  </script>
</body>
</html>
